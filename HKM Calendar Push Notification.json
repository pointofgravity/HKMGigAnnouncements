{"files":[{"id":"1debb41b-208b-4b32-863a-ddd7554a6055","name":"HKM_Reddit_Sidebar","type":"server_js","source":"// spiffy sidebar updater\n// https://github.com/chromakode/reddit-sidebar-updater\n//\n// Copyright (c) 2014 Max Goodman.\n// All rights reserved.\n//\n// Redistribution and use in source and binary forms, with or without\n// modification, are permitted provided that the following conditions\n// are met:\n// 1. Redistributions of source code must retain the above copyright\n//    notice, this list of conditions and the following disclaimer.\n// 2. Redistributions in binary form must reproduce the above copyright\n//    notice, this list of conditions and the following disclaimer in the\n//    documentation and/or other materials provided with the distribution.\n// 3. The name of the author or contributors may not be used to endorse or\n//    promote products derived from this software without specific prior\n//    written permission.\n//\n// THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS\u0027\u0027 AND\n// ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n// ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE\n// FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\n// DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\n// OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\n// HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\n// LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\n// OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\n// SUCH DAMAGE.\n\n// your subreddit must have a wiki page titled \"sidebar_template\", which can be\n// accessed by USERNAME (configured below). the template will be used as the\n// base content for the sidebar, with {{SCHEDULE}} replaced with a tabular\n// schedule from CALENDAR (configured below).\n\n\nvar CALENDAR \u003d \u0027ts8kgg7hsqfisjq3r2e8ijg1e0@group.calendar.google.com\u0027  // you must have subscribed to this calendar in Google Calendar\nvar SUBREDDIT \u003d \u0027HKM\u0027\nvar DAY_RANGE \u003d 30  // how many days ahead to list events for\nvar SCHEDULE_TIME_ZONE \u003d \u0027Asia/Hong_Kong\u0027\n\nvar CLIENT_ID \u003d \u0027g_KWxPuqGLaHfw\u0027  // your OAuth2 client ID\nvar CLIENT_SECRET \u003d \u0027ofYHjVzEyJ3Ri_nOFEdkVTq9IRA\u0027  // your OAuth2 client secret\n\n// please create a user solely for this script and mod them with wiki permissions only.\nvar USERNAME \u003d \u0027HKM_Calendar\u0027\nvar PASSWORD \u003d \u002712345678\u0027\n\n// the maximum sidebar length, set by reddit\nvar LENGTH_LIMIT \u003d 5120\n\nfunction updateSchedule() {\n  // get an OAuth2 token\n  var authData \u003d UrlFetchApp.fetch(\u0027https://ssl.reddit.com/api/v1/access_token\u0027, {\n    payload: {\n      grant_type: \u0027password\u0027,\n      scope: \u0027wikiread,wikiedit\u0027,\n      username: USERNAME,\n      password: PASSWORD\n    },\n    method: \u0027post\u0027,\n    headers: {\u0027Authorization\u0027: \u0027Basic \u0027 + Utilities.base64Encode(CLIENT_ID + \u0027:\u0027 + CLIENT_SECRET)}\n  })\n  authData \u003d JSON.parse(authData)\n  var authToken \u003d authData[\u0027access_token\u0027]\n\n  // load the sidebar template from reddit\u0027s wiki\n  var templateData \u003d UrlFetchApp.fetch(\u0027https://oauth.reddit.com/r/\u0027 + SUBREDDIT + \u0027/wiki/sidebar_template.json\u0027, {\n    headers: {\u0027Authorization\u0027: \u0027bearer \u0027 + authToken}\n  })\n  templateData \u003d JSON.parse(templateData)\n  var template \u003d templateData[\u0027data\u0027][\u0027content_md\u0027]\n  template \u003d template\n    .replace(/\u0026amp;/g, \u0027\u0026\u0027)\n    .replace(/\u0026lt;/g, \u0027\u003c\u0027)\n    .replace(/\u0026gt;/g, \u0027\u003e\u0027)\n    .replace(/\u0026quot;/g, \u0027\"\u0027)\n\n  // read the calendar for events and build our schedule table\n  var calendar \u003d CalendarApp.getCalendarById(CALENDAR)\n  var now \u003d new Date()\n  var dateStart \u003d new Date(now)\n  // look at events starting with the beginning of the current day\n  dateStart.setHours(0, 0, 0, 0)\n  var dateEnd \u003d new Date(now.getTime() + (DAY_RANGE * 24 * 60 * 60 * 1000))\n  var events \u003d calendar.getEvents(dateStart, dateEnd)\n  var sidebarTable \u003d \u0027\u0027\n  var sidebarLength \u003d template.length - \u0027{{SCHEDULE}}\u0027.length\n  for (var i \u003d 0; i \u003c events.length; i++) {\n    var event \u003d events[i]\n    var eventDate \u003d event.getStartTime()\n\n    // these four fields form each table line\n    var tableLine \u003d [\n      Utilities.formatDate(eventDate, SCHEDULE_TIME_ZONE, \u0027d MMM\u0027),\n      Utilities.formatDate(eventDate, SCHEDULE_TIME_ZONE, eventDate.getMinutes() !\u003d 0 ? \u0027h:mma\u0027 : \u0027ha\u0027).toLowerCase(),\n      event.getTitle() + \u0027\\n\u0027\n    ].join(\u0027|\u0027) + \u0027\\n\u0027\n\n    if (sidebarLength + tableLine.length \u003e LENGTH_LIMIT) {\n      break\n    } else {\n      sidebarTable +\u003d tableLine\n      sidebarLength +\u003d tableLine.length\n    }\n  }\n\n  \n  \n  // update the sidebar! :)\n  var sidebar \u003d template.replace(\u0027{{SCHEDULE}}\u0027, \"test\")\n  Logger.log(sidebar);\n  UrlFetchApp.fetch(\u0027https://oauth.reddit.com/r/\u0027 + SUBREDDIT + \u0027/api/wiki/edit\u0027, {\n    payload: {\n      content: sidebar,\n      page: \u0027config/sidebar\u0027,\n      reason: \u0027Automated Google Apps Script update @ \u0027 + Utilities.formatDate(now, \u0027America/Los_Angeles\u0027, \u0027d MMM h:mma z\u0027)\n    },\n    method: \u0027post\u0027,\n    headers: {\u0027Authorization\u0027: \u0027bearer \u0027 + authToken}\n  })\n  \n    // update the sidebar! :)\n  var sidebar \u003d template.replace(\u0027{{SCHEDULE}}\u0027, sidebarTable)\n  Logger.log(sidebar);\n  UrlFetchApp.fetch(\u0027https://oauth.reddit.com/r/\u0027 + SUBREDDIT + \u0027/api/wiki/edit\u0027, {\n    payload: {\n      content: sidebar,\n      page: \u0027config/sidebar\u0027,\n      reason: \u0027Automated Google Apps Script update @ \u0027 + Utilities.formatDate(now, \u0027America/Los_Angeles\u0027, \u0027d MMM h:mma z\u0027)\n    },\n    method: \u0027post\u0027,\n    headers: {\u0027Authorization\u0027: \u0027bearer \u0027 + authToken}\n  })\n}\n"}]}